generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(uuid())
  username              String                 @unique
  email                 String                 @unique
  passwordHash          String
  avatarUrl             String?
  createdAt             DateTime               @default(now())
  cooldownUntil         DateTime?
  isBanned              Boolean                @default(false)
  nsfwStrikes           Int                    @default(0)
  dateOfBirth           DateTime
  dobMethod             String?
  dobVerifiedAt         DateTime?
  lastStrikeAt          DateTime?
  lastReportAt          DateTime?
  reportAccuracy        Float                  @default(1.0)
  reportsConfirmed      Int                    @default(0)
  reportsRejected       Int                    @default(0)
  reportsSubmitted      Int                    @default(0)
  strikeUpdatedAt       DateTime?              @default(now())
  reportCooldownUntil   DateTime?
  lastRejectedAt        DateTime?
  lastRejectedSeverity  String?
  countryCode           String?
  locationUpdatedAt     DateTime?
  regionCode            String?
  lastKnownIp           String?
  comments              Comment[]
  chats                 CommunityChat[]
  sentInvitations       CommunityInvitation[]  @relation("InvitedBy")
  receivedInvitations   CommunityInvitation[]  @relation("InvitedUser")
  communityJoinRequests CommunityJoinRequest[]
  communityMemberships  CommunityMember[]
  profiles              FeedProfile[]
  likes                 Like[]
  posts                 Post[]
  reportsMade           Report[]
  superuser             Superuser?
  profile               UserProfile?
}

model Post {
  id                 String              @id @default(uuid())
  userId             String
  type               PostType
  caption            String?
  mediaUrl           String?
  watermarkUrl       String?
  createdAt          DateTime            @default(now())
  scope              FeedScope
  communityId        String?
  isCommunityOnly    Boolean             @default(false)
  rating             ContentRating       @default(SAFE)
  originCommunityId  String?
  originType         PostOriginType      @default(USER)
  isRemoved          Boolean             @default(false)
  originPostId       String?
  memeBottomText     String?
  memeTopText        String?
  countryCode        String?
  regionCode         String?
  comments           Comment[]
  communityFeedItems CommunityFeedItem[]
  likes              Like[]
  moderationActions  ModerationAction[]
  community          Community?          @relation(fields: [communityId], references: [id])
  originPost         Post?               @relation("PostOrigin", fields: [originPostId], references: [id])
  derivedPosts       Post[]              @relation("PostOrigin")
  user               User                @relation(fields: [userId], references: [id])
  categories         PostCategory[]
  reports            Report[]

  @@index([userId])
  @@index([scope])
  @@index([originPostId])
  @@index([communityId])
  @@index([rating])
  @@index([countryCode])
  @@index([regionCode])
}

model Comment {
  id            String            @id @default(uuid())
  postId        String
  userId        String
  body          String?
  mediaUrl      String?
  mediaType     CommentMediaType?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  isRemoved     Boolean           @default(false)
  removedAt     DateTime?
  removedBy     String?
  removedReason String?
  post          Post              @relation(fields: [postId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

model Community {
  id                    String                 @id @default(uuid())
  name                  String                 @unique
  intention             String
  scope                 CommunityScope
  createdBy             String
  createdAt             DateTime               @default(now())
  rating                ContentRating          @default(SAFE)
  categories            CommunityCategory[]
  chats                 CommunityChat[]
  communityFeedItems    CommunityFeedItem[]
  invitations           CommunityInvitation[]
  communityJoinRequests CommunityJoinRequest[]
  labelImports          CommunityLabelImport[]
  members               CommunityMember[]
  posts                 Post[]

  @@index([rating])
}

model CommunityFeedItem {
  id          String    @id @default(uuid())
  communityId String
  postId      String
  feedDate    DateTime
  rank        Int
  score       Int
  createdAt   DateTime  @default(now())
  reason      Json?
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([communityId, postId, feedDate])
  @@index([communityId, feedDate])
  @@index([communityId, feedDate, rank])
}

model CommunityMember {
  id          String        @id @default(uuid())
  communityId String
  userId      String
  role        CommunityRole @default(MEMBER)
  joinedAt    DateTime      @default(now())
  community   Community     @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
  @@index([communityId, role])
}

model CommunityInvitation {
  id            String           @id @default(uuid())
  communityId   String
  invitedById   String
  invitedUserId String
  status        InvitationStatus @default(PENDING)
  createdAt     DateTime         @default(now())
  expiresAt     DateTime
  community     Community        @relation(fields: [communityId], references: [id], onDelete: Cascade)
  invitedBy     User             @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedUser   User             @relation("InvitedUser", fields: [invitedUserId], references: [id])

  @@unique([communityId, invitedUserId])
}

model Category {
  key          String                 @id
  createdAt    DateTime               @default(now())
  scope        LabelScope
  countryCode  String?
  communities  CommunityCategory[]
  labelImports CommunityLabelImport[]
  posts        PostCategory[]
}

model CommunityCategory {
  id          String    @id @default(uuid())
  communityId String
  categoryKey String
  category    Category  @relation(fields: [categoryKey], references: [key])
  community   Community @relation(fields: [communityId], references: [id])

  @@index([categoryKey])
}

model CommunityLabelImport {
  id          String          @id @default(uuid())
  communityId String
  categoryKey String
  importMode  LabelImportMode
  category    Category        @relation(fields: [categoryKey], references: [key])
  community   Community       @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([communityId, categoryKey])
  @@index([communityId])
}

model PostCategory {
  id          String   @id @default(uuid())
  postId      String
  categoryKey String
  category    Category @relation(fields: [categoryKey], references: [key])
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, categoryKey])
  @@index([categoryKey])
}

model CommunityChat {
  id          String    @id @default(uuid())
  communityId String
  userId      String
  text        String
  createdAt   DateTime  @default(now())
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([communityId])
}

model UserProfile {
  userId   String   @id
  bio      String?  @db.VarChar(160)
  joinedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FeedProfile {
  id          String   @id @default(cuid())
  userId      String
  name        String
  isActive    Boolean  @default(false)
  preferences Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isDefault   Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model Report {
  id         String             @id @default(uuid())
  reporterId String
  postId     String
  reason     ReportReason
  context    String?
  createdAt  DateTime           @default(now())
  resolution ModerationOutcome?
  resolvedAt DateTime?
  post       Post               @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter   User               @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([reporterId])
}

model ModerationAction {
  id        String            @id @default(uuid())
  postId    String
  outcome   ModerationOutcome
  note      String?
  createdAt DateTime          @default(now())
  post      Post              @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model ModerationLog {
  id        String             @id @default(uuid())
  actorId   String
  actorType ModeratorActorType
  action    String
  targetId  String
  reason    String?
  createdAt DateTime           @default(now())
}

model Superuser {
  id        String        @id @default(dbgenerated("gen_random_uuid()"))
  userId    String        @unique
  role      SuperuserRole
  createdAt DateTime      @default(now())
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CommunityJoinRequest {
  id          String            @id @default(uuid())
  communityId String
  userId      String
  status      JoinRequestStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  community   Community         @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CommunityRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum LabelScope {
  GLOBAL
  COUNTRY
  LOCAL
}

enum PostOriginType {
  USER
  COMMUNITY
}

enum PostType {
  TEXT
  IMAGE
  VIDEO
  MEME
}

enum CommentMediaType {
  IMAGE
  GIF
  VIDEO
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  REVOKED
  EXPIRED
}

enum CommunityScope {
  LOCAL
  COUNTRY
  GLOBAL
}

enum FeedScope {
  LOCAL
  COUNTRY
  GLOBAL
}

enum JoinPolicy {
  OPEN
  APPROVAL_REQUIRED
  INVITE_ONLY
}

enum ContentRating {
  SAFE
  NSFW
}

enum LabelImportMode {
  SAFE_ONLY
  NSFW_ONLY
  BOTH
}

enum ReportReason {
  NSFW_EXPOSURE
  MINOR_SAFETY
  HARASSMENT
  HATE
  VIOLENCE
  SPAM
  MISINFORMATION
  OTHER
}

enum ModerationOutcome {
  NO_ACTION
  LIMITED
  REMOVED
  ESCALATED
}

enum ModeratorActorType {
  USER
  MODERATOR
  SUPERUSER
}

enum SuperuserRole {
  MODERATOR
  ADMIN
  LEGAL
}
