generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(uuid())
  username              String                 @unique
  email                 String                 @unique
  passwordHash          String
  avatarUrl             String?
  createdAt             DateTime               @default(now())
  cooldownUntil         DateTime?
  isBanned              Boolean                @default(false)
  nsfwStrikes           Int                    @default(0)
  dateOfBirth           DateTime
  dobMethod             String?
  dobVerifiedAt         DateTime?
  lastStrikeAt          DateTime?
  lastReportAt          DateTime?
  reportAccuracy        Float                  @default(1.0)
  reportsConfirmed      Int                    @default(0)
  reportsRejected       Int                    @default(0)
  reportsSubmitted      Int                    @default(0)
  strikeUpdatedAt       DateTime?              @default(now())
  reportCooldownUntil   DateTime?
  lastRejectedAt        DateTime?
  lastRejectedSeverity  String?
  countryCode           String?
  locationUpdatedAt     DateTime?
  regionCode            String?
  lastKnownIp           String?
  comments              Comment[]
  lastActiveAt          DateTime?
  lastLoginAt           DateTime?
  loginCount            Int                   @default(0)

  postCount             Int                   @default(0)
  commentCount          Int                   @default(0)
  reactionCount         Int                   @default(0)

  reputationScore       Float                 @default(0.0)
  shadowBanned          Boolean               @default(false)

  city                  String?
  timezone              String?
  nsfwEnabled           Boolean                @default(false)
  themeMode             ThemeMode              @default(LIGHT)
  accentTheme           AccentTheme            @default(CALM)

  chats                 CommunityChat[]
  sentInvitations       CommunityInvitation[]  @relation("InvitedBy")
  receivedInvitations   CommunityInvitation[]  @relation("InvitedUser")
  communityJoinRequests CommunityJoinRequest[]
  communityMemberships  CommunityMember[]
  profiles              FeedProfile[]
  notifications         Notification[] @relation("UserNotifications")
  notificationsSent     Notification[] @relation("ActorNotifications")
  likes                 Like[]
  posts                 Post[]
  reactions             Reaction[]
  reportsMade           Report[]
  superuser             Superuser?
  profile               UserProfile?
  actionLogs            UserActionLog[]
  passwordResetTokens PasswordResetToken[]
}

model Post {
  id                 String              @id @default(uuid())
  userId             String
  type               PostType
  caption            String?
  mediaUrl           String?
  watermarkUrl       String?
  createdAt          DateTime            @default(now())
  scope              FeedScope
  communityId        String?
  isCommunityOnly    Boolean             @default(false)
  rating             ContentRating       @default(SAFE)
  originCommunityId  String?
  originType         PostOriginType      @default(USER)
  isRemoved          Boolean             @default(false)
  originPostId       String?
  shareCount         Int                 @default(0)
  memeBottomText     String?
  memeTopText        String?
  memeMeta           Json?
  countryCode        String?
  regionCode         String?
  comments           Comment[]
  communityFeedItems CommunityFeedItem[]
  likes              Like[]
  reactions          Reaction[]
  moderationActions  ModerationAction[]
  notifications      Notification[]
  community          Community?          @relation(fields: [communityId], references: [id])
  originPost         Post?               @relation("PostOrigin", fields: [originPostId], references: [id])
  derivedPosts       Post[]              @relation("PostOrigin")
  user               User                @relation(fields: [userId], references: [id])
  categories         PostCategory[]
  reports            Report[]

  @@index([userId])
  @@index([scope])
  @@index([originPostId])
  @@index([communityId])
  @@index([rating])
  @@index([countryCode])
  @@index([regionCode])
  @@index([createdAt])
}

model Comment {
  id              String            @id @default(uuid())
  postId          String
  userId          String
  parentCommentId String?
  body            String?
  mediaUrl        String?
  mediaType       CommentMediaType?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  isRemoved       Boolean           @default(false)
  removedAt       DateTime?
  removedBy       String?
  removedReason   String?
  memeMeta        Json?

  post            Post              @relation(fields: [postId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  parent          Comment?          @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         Comment[]         @relation("CommentReplies")
  reactions       Reaction[]
  notifications   Notification[]
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
  @@index([parentCommentId])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

model Reaction {
  id        String   @id @default(uuid())
  userId    String
  postId    String?
  commentId String?
  type      ReactionType
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId, type])
  @@unique([userId, commentId, type])
  @@index([postId])
  @@index([commentId])
}


model Notification {
  id            String            @id @default(uuid())

  recipientId   String
  actorId       String?

  postId        String?
  commentId     String?
  communityId   String?

  type          NotificationType

  mentionedUsername String?

  readAt        DateTime?
  createdAt     DateTime          @default(now())

  recipient     User              @relation("UserNotifications", fields: [recipientId], references: [id], onDelete: Cascade)
  actor         User?             @relation("ActorNotifications", fields: [actorId], references: [id], onDelete: SetNull)

  post          Post?             @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment       Comment?          @relation(fields: [commentId], references: [id], onDelete: Cascade)
  community     Community?        @relation(fields: [communityId], references: [id], onDelete: Cascade)

  dedupeKey     String?
  metadata      Json?

  @@index([recipientId, createdAt])
  @@index([recipientId, readAt])
  @@index([postId])
  @@index([commentId])
  @@index([communityId])
  @@index([dedupeKey])
}

model Community {
  id                    String                 @id @default(uuid())
  name                  String                 @unique
  intention             String
  scope                 CommunityScope
  createdBy             String
  createdAt             DateTime               @default(now())
  rating                ContentRating          @default(SAFE)
  categories            CommunityCategory[]
  chats                 CommunityChat[]
  communityFeedItems    CommunityFeedItem[]
  invitations           CommunityInvitation[]
  communityJoinRequests CommunityJoinRequest[]
  labelImports          CommunityLabelImport[]
  members               CommunityMember[]
  posts                 Post[]
  notifications         Notification[]

  @@index([rating])
}

model CommunityFeedItem {
  id          String    @id @default(uuid())
  communityId String
  postId      String
  feedDate    DateTime
  rank        Int
  score       Int
  createdAt   DateTime  @default(now())
  reason      Json?
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([communityId, postId, feedDate])
  @@index([communityId, feedDate])
  @@index([communityId, feedDate, rank])
}

model CommunityMember {
  id          String        @id @default(uuid())
  communityId String
  userId      String
  role        CommunityRole @default(MEMBER)
  joinedAt    DateTime      @default(now())
  community   Community     @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
  @@index([communityId, role])
}

model CommunityInvitation {
  id            String           @id @default(uuid())
  communityId   String
  invitedById   String
  invitedUserId String
  status        InvitationStatus @default(PENDING)
  createdAt     DateTime         @default(now())
  expiresAt     DateTime
  community     Community        @relation(fields: [communityId], references: [id], onDelete: Cascade)
  invitedBy     User             @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedUser   User             @relation("InvitedUser", fields: [invitedUserId], references: [id])

  @@unique([communityId, invitedUserId])
}

model Category {
  key          String                 @id
  createdAt    DateTime               @default(now())
  scope        LabelScope
  countryCode  String?
  communities  CommunityCategory[]
  labelImports CommunityLabelImport[]
  posts        PostCategory[]
}

model CommunityCategory {
  id          String    @id @default(uuid())
  communityId String
  categoryKey String
  category    Category  @relation(fields: [categoryKey], references: [key])
  community   Community @relation(fields: [communityId], references: [id])

  @@index([categoryKey])
}

model CommunityLabelImport {
  id          String          @id @default(uuid())
  communityId String
  categoryKey String
  importMode  LabelImportMode

  global      Boolean         @default(true)
  country     Boolean         @default(true)
  local       Boolean         @default(true)

  category    Category        @relation(fields: [categoryKey], references: [key])
  community   Community       @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([communityId, categoryKey])
  @@index([communityId])
}


model PostCategory {
  id          String   @id @default(uuid())
  postId      String
  categoryKey String
  category    Category @relation(fields: [categoryKey], references: [key])
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, categoryKey])
  @@index([categoryKey])
}

model CommunityChat {
  id          String    @id @default(uuid())
  communityId String
  userId      String
  text        String
  createdAt   DateTime  @default(now())
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([communityId])
}

model UserProfile {
  userId   String   @id
  bio      String?  @db.VarChar(160)
  joinedAt DateTime @default(now())
  showCommunities   Boolean  @default(true)
  showCommunityPosts Boolean @default(true)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FeedProfile {
  id          String   @id @default(cuid())
  userId      String
  name        String
  isActive    Boolean  @default(false)
  preferences Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isDefault   Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model Report {
  id         String             @id @default(uuid())
  reporterId String
  postId     String
  reason     ReportReason
  context    String?
  createdAt  DateTime           @default(now())
  resolution ModerationOutcome?
  resolvedAt DateTime?
  post       Post               @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter   User               @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@unique([reporterId, postId])
  @@index([postId])
  @@index([reporterId])
}

model UserActionLog {
  id          String      @id @default(uuid())
  userId      String
  action      ActionType
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, action, createdAt])
  @@index([createdAt])
}

model ModerationAction {
  id        String            @id @default(uuid())
  postId    String
  outcome   ModerationOutcome
  note      String?
  createdAt DateTime          @default(now())
  post      Post              @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model ModerationLog {
  id        String             @id @default(uuid())
  actorId   String
  actorType ModeratorActorType
  action    String
  targetId  String
  reason    String?
  createdAt DateTime           @default(now())
}

model Superuser {
  id        String        @id @default(dbgenerated("gen_random_uuid()"))
  userId    String        @unique
  role      SuperuserRole
  createdAt DateTime      @default(now())
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CommunityJoinRequest {
  id          String            @id @default(uuid())
  communityId String
  userId      String
  status      JoinRequestStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  community   Community         @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CommunityRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum LabelScope {
  GLOBAL
  COUNTRY
  LOCAL
}

enum PostOriginType {
  USER
  COMMUNITY
}

enum PostType {
  TEXT
  IMAGE
  VIDEO
  MEME
}

enum CommentMediaType {
  IMAGE
  GIF
  VIDEO
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  REVOKED
  EXPIRED
}

enum CommunityScope {
  LOCAL
  COUNTRY
  GLOBAL
}

enum FeedScope {
  LOCAL
  COUNTRY
  GLOBAL
}

enum JoinPolicy {
  OPEN
  APPROVAL_REQUIRED
  INVITE_ONLY
}

enum ContentRating {
  SAFE
  NSFW
}

enum LabelImportMode {
  SAFE_ONLY
  NSFW_ONLY
  BOTH
}

enum ReportReason {
  NSFW_EXPOSURE
  MINOR_SAFETY
  HARASSMENT
  HATE
  VIOLENCE
  SPAM
  MISINFORMATION
  OTHER
}

enum ModerationOutcome {
  NO_ACTION
  LIMITED
  REMOVED
  ESCALATED
}

enum ModeratorActorType {
  USER
  MODERATOR
  SUPERUSER
}

enum SuperuserRole {
  MODERATOR
  ADMIN
  LEGAL
}


enum ThemeMode {
  LIGHT
  DARK
}

enum AccentTheme {
  CALM
  FOREST
  SAND
  LAVENDER
  SLATE
  SUNSET
  SAGE
  LAVENDER_MIST
  OCEAN_SLATE
  REDDIT
SUN_ORANGE
SKY_BLUE
TURQUOISE
SOFT_GREEN

}

enum NotificationType {
  LIKE_POST
  COMMENT_POST
  REPLY_COMMENT
  MENTION_POST
  MENTION_COMMENT
  COMMUNITY_INVITE
  COMMUNITY_POST
  SYSTEM
}

enum ActionType {
  POST_CREATE
  COMMENT_CREATE
  LIKE_TOGGLE
  REPORT_CREATE
  MEDIA_UPLOAD
  LOGIN_ATTEMPT
  PASSWORD_RESET_ATTEMPT
  PROFILE_UPDATE
  COMMUNITY_CREATE
  COMMUNITY_JOIN
  COMMUNITY_INVITE
  MODERATION_ACTION
}

enum ReactionType {
  LIKE
  LOVE
  LAUGH
  FIRE
  SAD
  ANGRY
}