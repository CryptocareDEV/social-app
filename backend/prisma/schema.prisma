generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ============================
 * ENUMS
 * ============================
 */

enum CommunityRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum PostType {
  TEXT
  IMAGE
  VIDEO
  MEME
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  REVOKED
}

enum CommunityScope {
  LOCAL
  COUNTRY
  GLOBAL
}

enum FeedScope {
  LOCAL
  COUNTRY
  GLOBAL
}

enum ContentRating {
  SAFE
  NSFW
}

/**
 * ============================
 * USER
 * ============================
 */

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  email        String   @unique
  passwordHash String
  avatarUrl    String?
  createdAt    DateTime @default(now())

  nsfwStrikes   Int       @default(0)
  isBanned      Boolean   @default(false)
  cooldownUntil DateTime?

  posts                Post[]
  likes                Like[]
  communityMemberships CommunityMember[]
  chats                CommunityChat[]

  sentInvitations     CommunityInvitation[] @relation("InvitedBy")
  receivedInvitations CommunityInvitation[] @relation("InvitedUser")
}

/**
 * ============================
 * POSTS
 * ============================
 */

model Post {
  id           String   @id @default(uuid())
  userId       String
  type         PostType
  caption      String?
  mediaUrl     String?
  watermarkUrl String?
  createdAt    DateTime @default(now())

  scope FeedScope

  communityId     String?
  isCommunityOnly Boolean @default(false)

  rating ContentRating @default(SAFE)

  user      User       @relation(fields: [userId], references: [id])
  community Community? @relation(fields: [communityId], references: [id])

  likes              Like[]
  categories         PostCategory[]
  communityFeedItems CommunityFeedItem[]

  @@index([userId])
  @@index([scope])
  @@index([communityId])
  @@index([rating])
}

/**
 * ============================
 * LIKES
 * ============================
 */

model Like {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

/**
 * ============================
 * COMMUNITIES
 * ============================
 */

model Community {
  id        String         @id @default(uuid())
  name      String
  intention String
  scope     CommunityScope
  createdBy String
  createdAt DateTime       @default(now())

  rating ContentRating @default(SAFE)

  // âœ… REQUIRED inverse relation
  posts Post[]

  categories         CommunityCategory[]
  members            CommunityMember[]
  invitations        CommunityInvitation[]
  communityFeedItems CommunityFeedItem[]
  chats              CommunityChat[]

  @@index([rating])
}

/**
 * ============================
 * COMMUNITY FEED
 * ============================
 */

model CommunityFeedItem {
  id          String   @id @default(uuid())
  communityId String
  postId      String
  feedDate    DateTime
  rank        Int
  score       Int
  reason      Json?
  createdAt   DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([communityId, postId, feedDate])
  @@index([communityId, feedDate])
  @@index([communityId, feedDate, rank])
}

/**
 * ============================
 * COMMUNITY MEMBERS
 * ============================
 */

model CommunityMember {
  id          String        @id @default(uuid())
  communityId String
  userId      String
  role        CommunityRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
  @@index([communityId, role])
}

/**
 * ============================
 * INVITATIONS
 * ============================
 */

model CommunityInvitation {
  id            String @id @default(uuid())
  communityId   String
  invitedById   String
  invitedUserId String

  status    InvitationStatus @default(PENDING)
  expiresAt DateTime
  createdAt DateTime         @default(now())

  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedUser User      @relation("InvitedUser", fields: [invitedUserId], references: [id])

  @@unique([communityId, invitedUserId])
}

/**
 * ============================
 * CATEGORIES
 * ============================
 */

model Category {
  key       String   @id
  createdAt DateTime @default(now())

  posts       PostCategory[]
  communities CommunityCategory[]
}

model CommunityCategory {
  id          String @id @default(uuid())
  communityId String
  categoryKey String

  community Community @relation(fields: [communityId], references: [id])
  category  Category  @relation(fields: [categoryKey], references: [key])

  @@index([categoryKey])
}

model PostCategory {
  id          String @id @default(uuid())
  postId      String
  categoryKey String

  post     Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryKey], references: [key])

  @@unique([postId, categoryKey])
  @@index([categoryKey])
}

model CommunityChat {
  id          String   @id @default(uuid())
  communityId String
  userId      String
  text        String
  createdAt   DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([communityId])
}
